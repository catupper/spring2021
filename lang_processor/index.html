<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>言語処理系 - K-kai Hackathon Spring 2021</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">K-kai Hackathon Spring 2021</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">言語処理系</a>
                            </li>
                            <li class="navitem">
                                <a href="../hard_computing/" class="nav-link">計算困難問題</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../hard_computing/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#_1" class="nav-link">言語処理系</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">インタプリタとコンパイラ</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#hq9" class="nav-link">HQ9+</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#brainfk" class="nav-link">BrainF**k</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_4" class="nav-link">構文解析</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1">言語処理系</h1>
<p><strong>言語処理系</strong> というのはプログラミング言語を受け取って、何らかの処理をしてくれるソフトウェアのことである。Processing, Python, C/C++など様々な言語があるが、人間が書いたソースコードが無事にプログラムとして実行されるまでには、言語処理系が間に挟まって、ソースコードの解釈や、機械語への変換を行っている。
本テーマでは、いろいろなタイプの言語処理系を作ってみて、最終的にはひとつ言語を自作するなどしてもらう。</p>
<p>このページではサンプルコードは全てPython3で書かれているが、受講者が好きな言語を使ってもらって構わない。</p>
<h2 id="_2">インタプリタとコンパイラ</h2>
<p>言語処理系は<strong>インタプリタ型</strong>と<strong>コンパイラ型</strong>に大別される。</p>
<p>インタプリタ型言語は、ソースコードを機械語に翻訳せずに実行する言語処理系である。Python, Rubyなどがインタプリタ型言語の例である。プログラムを上から順番に読んでいって逐一実行するだけ、という実装が多いので、対話型コンソールとの相性がよい。</p>
<p>それに対して、コンパイラ型言語は、ソースコードを一度機械語に変換してからプログラムを実行する。一般には機械語に変換するところまでがコンパイラ型言語処理系の仕事である。例えばC言語でプログラムをコンパイルするとa.exeなどと言った実行ファイルが出来上がるが、これがソースコードが機械語に翻訳されたものである。
機械語に変換するまでに時間がかかるが、その後の実行速度はインタプリタ型と比較すると速くなる。</p>
<p>コンパイル型原碁を自作する場合は機械語の知識が必要で、少し難しいので、今回はインタプリタ型言語を作成することにする。</p>
<h2 id="hq9">HQ9+</h2>
<p>まずは<a href="https://ja.wikipedia.org/wiki/HQ9%2B">HQ9+</a>というプログラミング言語の処理系を作ってみよう。
HQ9+はほとんど何もできないジョーク言語だが、処理系を作る練習として選ぶには良い言語である。</p>
<h3 id="hq9_1">HQ9+ の仕様</h3>
<p>HQ9+の仕様を以下に挙げる。</p>
<ul>
<li>ソースコードを先頭から順に読んでいくインタプリタ型言語である。</li>
<li>ソースコードを読んでいき'H'が出てきたら、'Hello, World!'を出力する。</li>
<li>ソースコードを読んでいき'Q'が出てきたら、ソースコードを出力する。</li>
<li>ソースコードを読んでいき'9'が出てきたら、"99 Bottles of Beer"の<a href="http://99-bottles-of-beer.net/lyrics.html">歌詞</a>を出力する。</li>
<li>ソースコードを読んでいき'+'が出てきたら、アキュムレータの値を1増やす。</li>
<li>それ以外の文字が出てきた場合は、何もしない。</li>
</ul>
<p>ここでアキュムレータというのは、プログラムの裏側にある変数だと思ってもらえれば良い。プログラム開始時にはアキュムレータは0に初期化されている。
このアキュムレータの値を出力することはないので、実際にアキュムレータを実装する必要はないのだが、練習のために今回は実装してみよう。</p>
<h3 id="hq9_2">HQ9+ の実装</h3>
<p>まず雛形としてソースコードを読み取る関数<code>read_code</code>を作ってみよう。
コマンドライン引数からソースコードのパスを読み取り、その内容を返す関数である。
コマンドライン引数の個数がおかしかったり、与えられたパスが存在しなかった場合も適切にエラー処理をする。
<code>sys.argv</code> はコマンドライン引数の配列である。
<code>python hoge.py fuga piyo</code>というふうに<code>hoge.py</code>を実行したならば<code>sys.argv</code>は<code>["hoge.py", "fuga", "piyo"]</code>となる。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="n">argvs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
<span class="n">argc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argvs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_code</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no source file&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;too many arguments&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">argvs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no such file:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sourcecode</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sourcecode</span>
</code></pre></div>

<p>この雛形は他の言語を作るときにも利用するのでローカルに名前を付けて保存しておくと良いだろう。</p>
<p>次に、ソースコードを順に読み、コマンドを実行していく関数<code>process(sourcecode)</code>を書こう。各コマンドの処理はまだ具体的に書かず、関数の形で置いておく。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">sourcecode</span><span class="p">):</span>
    <span class="n">accumulator</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sourcecode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="n">command_h</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="n">command_q</span><span class="p">(</span><span class="n">sourcecode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span><span class="n">command_9</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span><span class="n">command_plus</span><span class="p">()</span>
</code></pre></div>

<p>あとは、それぞれのコマンドを実装するだけである。ここではHと+の実装例を示すので、残りの2コマンドは自分で実装してみてほしい。</p>
<p><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">command_h</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">command_plus</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">accumulator</span>
    <span class="n">accumulator</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">command_9</span><span class="p">():</span>
    <span class="c1">#自分で実装する</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">command_q</span><span class="p">(</span><span class="n">sourcecode</span><span class="p">):</span>
    <span class="c1">#自分で実装する</span>
    <span class="k">pass</span>
</code></pre></div>
これらを実装し終わったあとは、以下のコードを最後に追加すれば、実行できるようになる。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">sourcecode</span> <span class="o">=</span> <span class="n">read_code</span><span class="p">()</span>
    <span class="n">process</span><span class="p">(</span><span class="n">sourcecode</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h3 id="_3">演習:自作機能を追加してみよう</h3>
<p>HQ9+は見ての通り低機能なプログラミング言語である。ここに自分の好きなコマンドを追加してみよう。以下に挙げるのは講師が思いついた例であるが、ここにないものでもよい。</p>
<ul>
<li>Fコマンド: 1から100までのFizzBuzzを出力する</li>
<li>Oコマンド：アキュミュレータの値を出力する</li>
<li>-コマンド：アキュミュレータの値を1減らす</li>
</ul>
<h2 id="brainfk">BrainF**k</h2>
<p>次に、HQ9+より高機能な<strong>BrainF**k</strong>の実装をしてみよう。BrainF**kはチューリング完全といって、チューリングマシンと同等の処理能力が有るプログラミング言語である。C/C++やPythonのような、いわゆる「なんでもできるプログラミング言語」だと考えてもらって構わない。</p>
<h3 id="brainfk_1">BrainF**kの仕様</h3>
<p>BrainF**kの仕様を以下に挙げる。</p>
<ul>
<li>ソースコードを先頭から順に読んでいくインタプリタ型言語である。</li>
<li>'&gt;'が出てきたら、ポインタをインクリメントする。</li>
<li>'&lt;'が出てきたら、ポインタをデクリメントする。</li>
<li>'+'が出てきたら、ポインタが指している値をインクリメントする。</li>
<li>'-'が出てきたら、ポインタが指している値をデクリメントする。</li>
<li>'.'が出てきたら、ポインタが指す値の文字コードを持つ文字を出力する。</li>
<li>','が出てきたら、入力から1文字読み込んで、その文字コードの値をポインタが指す先に代入する。</li>
<li>'['が出てきたら、ポインタが指す値が0なら対応する']'にジャンプする。</li>
<li>']'が出てきたら、ポインタが指す値が0でないなら、対応する'['にジャンプする。</li>
<li>それ以外の文字が出てきた場合は、何もしない。</li>
</ul>
<p>仕様に出てきた「ポインタ」という単語について説明しよう。
HQ9+ではアキュムレータという変数のようなものがあったが、BrainF**kでは無限に長い一次元配列が裏にあると考えてもらってよい。
はじめ、その配列の値は全て0で初期化されており、ポインタがある要素を指している。
ポインタがインクリメントされると、そのひつ次の要素を指すようになり、デクリメントすると、その一つ前の要素を指すようになる。
ポインタが指す要素の値を変えたいならば'+'や'-'を使って値を書き換える。</p>
<p>また、'.',','でポインタの指す値の文字コードに対応する文字がないとうまく動かないので、'+'や'-'コマンドは256で割ったあまりを動くとする。つまり255をインクリメントすると0, 0をデクリメントすると255になる仕様であるとする。</p>
<h3 id="brainfk_2">BrainF**kの実装</h3>
<p><code>read_code</code>はHQ9+と同じものを使って構わない。
HQ9+のときはアキュミュレータをグローバル変数として実装したが、実際にはこのような実装はあまり美しくない。今回はBFクラスを作成して、各コマンドや内部環境をそのクラスのインスタンスとして実装しよう。
実際に無限に長い配列を用意することはできないので、十分長い配列としてサイズ1000の配列を用意して、初めポインタは500番目の要素を指していることにしよう。</p>
<p>pythonで1文字単位の標準入出力をするときは<code>sys.stdin.read</code>, <code>sys.stdout.write</code>を使おう。
以下にBFクラスの実装を挙げる。いくつかの機能を未実装に済ませているので、そこは各自で実装してみよう。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BF</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourcecode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">sourcecode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#今ソースコードの何文字目を見ているか</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="mi">500</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">plus</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">minus</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dot</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">comma</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bra</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">cket</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointer</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">plus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pointer</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">minus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pointer</span><span class="p">]))</span>        

    <span class="k">def</span> <span class="nf">comma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">bra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pointer</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span><span class="k">return</span>
        <span class="n">bracket</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bracket</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
                <span class="n">bracket</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
                <span class="n">bracket</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bracket</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bracket is broken&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
</code></pre></div>

<p>以下のBrainF**kのコードはHello Worldを出力するプログラムである。
実行して、インタプリタがしっかり動いているか確かめてみよう。</p>
<div class="highlight"><pre><span></span><code>&gt;+++++++++[&lt;++++++++&gt;-]&lt;.&gt;+++++++[&lt;++++&gt;-]&lt;+.+++++++..+++.[-]&gt;++++++++[&lt;++++&gt;-]&lt;.&gt;+++++++++++[&lt;+++++&gt;-]&lt;.&gt;++++++++[&lt;+++&gt;-]&lt;.+++.------.--------.[-]&gt;++++++++[&lt;++++&gt;-]&lt;+.[-]++++++++++.
</code></pre></div>

<p>もし余力があったら、BrainF**kで入力された数字の和を出力するプログラムなどを作ってみよう。とても難しいことがわかる。</p>
<h2 id="_4">構文解析</h2>
<p>HQ9+もBrainF**kも大して難しい構文解析は行わなかった。人間が読みやすいプログラミング言語は、多少高度な構文解析を行わなければコード解釈ができない。
構文解析の練習として以下の機能を持つ対話型シェルを作ってみよう。</p>
<ul>
<li>四則演算が処理できる。ただし左から順に計算する優先順位である。括弧には対応していない</li>
<li>変数に対応している。</li>
<li>数式を1行入力してエンターを押すと、それを計算し、成功すれば結果を出力し、失敗すればエラーを吐く</li>
<li><code>x = 3</code>というふうに<code>(変数名) = (値)</code> とすると変数を宣言したり、値を設定したりできる。</li>
</ul>
<p>ここで、どのような入力が構文として正しいいのかを示すために、BNFという表記を導入する。これから実装する言語の正当な1行の命令に対応するBNFは以下のようになる。</p>
<div class="highlight"><pre><span></span><code>&lt;command&gt; ::= &lt;substitute&gt; | &lt;formula&gt;

&lt;substitute&gt; ::= &lt;variable&gt; &#39;=&#39; &lt;formula&gt;

&lt;formula&gt; ::= 　　&lt;number&gt; &#39;+&#39; &lt;formula&gt;
          | &lt;number&gt; &#39;*&#39; &lt;formula&gt;
          | &lt;number&gt; &#39;-&#39; &lt;formula&gt;
          | &lt;number&gt; &#39;/&#39; &lt;formula&gt;
          | &lt;number&gt;

&lt;number&gt; ::= &lt;constant&gt; | &lt;variable&gt;

&lt;variable&gt; ::= &lt;alphabet&gt; | &lt;alphabet&gt; &lt;variable&gt;

&lt;alphabet&gt; ::= &#39;a&#39; | &#39;b&#39; | .. | &#39;z&#39;

&lt;constant&gt; ::= &lt;digit&gt; | &lt;digit&gt; &lt;constant&gt;

&lt;digit&gt; ::= &#39;0&#39; | &#39;1&#39; | &#39;2&#39; | .. | &#39;9&#39;
</code></pre></div>

<p>BNFの記法は <code>::=</code>の左のパターンが右に書いたパターンとマッチするということを定義している。</p>
<p>たとえば最後の一行は、<digit>は'0'や'1'などの一文字の数字にマッチすることを表している。
最後から二行目は<number>は<digit>単体もしくは<digit>のあとに<number>が来るものとマッチすることを表している。
これはつまり<digit>が1つ以上並んだものが<number>であることを表している。</p>
<p>上のBNF記法で書かれた文法の仕様に則って、まずは構文解析器を作ってみよう。</p>
<h3 id="_5">構文解析の実装</h3>
<p>まずは文字列が与えられた時に、先頭の整数だけ取り出して、残りと分離する関数を実装してみよう。</p>
<p><div class="highlight"><pre><span></span><code><span class="n">DIGITS</span> <span class="o">=</span> <span class="s2">&quot;0123456789&quot;</span>
<span class="k">def</span> <span class="nf">read_constant</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="ow">and</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">i</span><span class="p">]),</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
</code></pre></div>
一文字目から順番に見ていって、数字ではなくなるところまで全部取って、整数として読み込みというコードである。</p>
<p>次に<code>&lt;number&gt;</code>を処理する関数を実装しよう。<code>read_number(string)</code>とすると'string'の先頭から、整数もしくは変数を読み取って、残りと分離する関数である。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_number</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_constant</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALPHABETS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_variable</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>
</code></pre></div>

<p>この次は<code>&lt;formula&gt;</code>を処理する関数を実装しよう。<code>read_formula(string)</code>とすると<code>string</code>を式として解釈してその計算結果を返すようにしよう。</p>
<div class="highlight"><pre><span></span><code><span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">def</span> <span class="nf">read_formula</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">num</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">read_number</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no such variable </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rest</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="n">read_formula</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>
</code></pre></div>

<p>ここで,<code>env</code>は連想配列で、将来的には変数名をキーとして、その変数の値を格納するものである。envはenvironment(環境)の略で、現在の変数の状況を管理しているものと考えてもらって良い。</p>
<p>最後に、commandを実装すれば変数を使わず代入もせず足し算しかできないインタプリタが完成するはずだ。</p>
<p><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">read_command</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">read_substitute</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;set </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">read_formula</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>


<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">read_command</span><span class="p">(</span><span class="nb">input</span><span class="p">())</span>
</code></pre></div>
ここでは'='が含まれていれば代入分で、そうでなければただの式だと判定している。</p>
<p>ここまでのものと、これから実装しなければならないものをまとめると以下のようになる。</p>
<div class="highlight"><pre><span></span><code><span class="n">DIGITS</span> <span class="o">=</span> <span class="s2">&quot;0123456789&quot;</span>
<span class="n">ALPHABETS</span> <span class="o">=</span> <span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
<span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_number</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_constant</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALPHABETS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_variable</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_constant</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="ow">and</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">i</span><span class="p">]),</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>


<span class="k">def</span> <span class="nf">read_variable</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="c1">#自分で実装する</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">read_formula</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">num</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">read_number</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no such variable </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rest</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="n">read_formula</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="c1">#自分で実装する</span>
        <span class="k">pass</span>
    <span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_substitute</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">var</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">read_variable</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;syntax_error&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_formula</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">var</span>

<span class="k">def</span> <span class="nf">read_command</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">read_substitute</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;set </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">read_formula</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>


<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">read_command</span><span class="p">(</span><span class="nb">input</span><span class="p">())</span>
</code></pre></div>

<p>このままでは足し算しかできないので、<code>#自分で実装する</code>と書いてある場所を埋めて、変数や他の演算子に対応しているようにしよう。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
